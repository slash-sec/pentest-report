\chapter{Beschreibung des Prüfsystems}
\label{chapter:details_pruefsystem}
Für die Durchführung des Penetrationstests 
\begin{itemize} 
	\color{red}
	\item TODO: Auf Einheitlichkeit achten. Sonst wurde  immer "Penetration-Test" geschrieben. Find and replace- Funktion nutzen.
\end{itemize}
wurde die auf Debian basierte \textit{Kali}\footnote{\url{https://www.kali.org}}-Distribution von \textit{Offensive Security} verwendet. Als Virtualisierungslösung einer virtuellen Maschine (kurz: VM) wurde VirtualBox\footnote{\url{https://www.virtualbox.org/}} von Oracle eingesetzt. Zur Wahrung der Vertraulichkeit der im Penetrationstest erlangten Kundeninformationen wurde bei der Kali-VM die von VirtualBox zur Verfügung gestellte Festplattenverschlüsselung aktiviert. Diese sorgt dafür, dass nach der offensiven Sicherheitsüberprüfung durch das Löschen der VM sowie des Passworts zur Festplattenverschlüsselung die Daten rückstandslos beim Dienstleister gelöscht werden. Tabelle  \ref{tab:setup_details} zeigt die Details zu den verwendeten Versionen und Hardwareparameter auf. Darüber hinaus wurde am 11. Oktober 2021 um 11:01:55 +0200 Uhr von Hr. Ruhl die OpenVPN\footnote{\url{https://openvpn.net/}}-Konfigurationsdatei zur Einwahl in das Zielnetzwerk per verschlüsselter PGP-E-Mail an Hr. Siemens zur Verfügung gestellt. Die SHA256-Prüfsumme der originalen VPN-Konfigurationsdatei ist ebenfalls in Tabelle \ref{tab:setup_details} aufgeführt.
\begin{itemize} 
	\color{red}
	\item TODO: Die Spalten der Tabellen waren sonst immer linksbündig. 
\end{itemize}
\begin{table}[h!]
    \centering
    \begin{tabular}[h]{|c|c|}
    \hline
    \textbf{VirtualBox Version} & \texttt{6.1.30 r148432} \\
    \hline
    \textbf{Kali VirtualBox Imageversion} & \texttt{Kali-Linux-2021.4a-virtualbox-amd64} \\
    \hline
    \textbf{Kali-Image SHA256-Prüfsumme} & \makecell{\texttt{799d0244ca57b3e9d38c2d542f7337f0} \\ \texttt{92fe685c0168005ca695e8a43f85940e}}\\
    \hline
    \textbf{Kali Linux-Version} & \texttt{5.15.0-kali2-amd64} \\
    \hline
    \textbf{Festplattenverschlüsselung} & \texttt{AES-XTS128-PLAIN64} \\
    \hline
    \textbf{Virtuelle CPU-Kerne} & \texttt{4} \\
    \hline
    \textbf{Zugewiesener Arbeitsspeicher} & \texttt{4 GB} \\
    \hline
    \textbf{Hostname} & \texttt{kali-t470} \\
    \hline
    \textbf{Benutzername} & \texttt{gu4c4m0l3} \\
    \hline
    \textbf{\makecell{SHA256-Prüfsumme \\ (originale) OpenVPN-Datei} } & \makecell{\texttt{c5fdf59062a3fc31de1121a3760f6b42} \\ \texttt{9b8838226726ff65abbbc79a79076293}}\\
    \hline
    \end{tabular}
\caption{Details zum verwendeten Prüfsystem}
\label{tab:setup_details}
\end{table}

\section{Beschreibung der VPN-Einwahl}
Um anstelle des VPN-Split-Tunneling jeglichen gerouteten Netzwerkverkehr durch den VPN-Tunnel zu senden und die DNS-Konfiguration innerhalb der Kali-VM automatisch nach VPN-Tunnel Auf- und Abbau zu aktualisieren, wurde die originale VPN-Konfiguration um vier Zeilen erweitert (siehe Textauszug \ref{lst:custom_vpn_config}). Um das im Textauszug angegebene Skript in Zeile 3 und 4 (\texttt{/etc/openvpn/update-resolv-conf}) erfolgreich ausführen zu können, wird die vorherige Installation des \texttt{resolvconf}-Pakets vorausgesetzt. Das Paket kann mittels dem Befehl \texttt{sudo apt install resolvconf} nachinstalliert werden.


\lstset{language=bash,caption={OpenVPN Full-Tunnel Konfigurationserweiterung}, label=lst:custom_vpn_config}
\begin{lstlisting}[frame=single, firstnumber=1, stepnumber=1,]
script-security 2
redirect-gateway def1
up /etc/openvpn/update-resolv-conf
down /etc/openvpn/update-resolv-conf
\end{lstlisting}

Die OpenVPN-Konfigurationsdatei wurde anschließend unter folgendem Pfad innerhalb der Kalil-VM abgelegt: \texttt{/etc/openvpn/COOLcamp\_ssi\_full.ovpn}. Folgender Befehl baut den VPN-Tunnel zum Kundennetzwerk auf: \texttt{sudo openvpn --config /etc/openvpn/COOLcamp\_ssi\_full.ovpn}

Textauszug \ref{lst:vpn_connect} zeigt einen erfolgreichen VPN-Verbindungsaufbau.
\lstset{caption={Erfolgreiche VPN-Verbindung zum Kundennetzwerk}, label=lst:vpn_connect}
\begin{lstlisting}[frame=single, firstnumber=1, stepnumber=1,]
$ sudo openvpn --config /etc/openvpn/COOLcamp_ssi_full.ovpn 
[sudo] password for gu4c4m0l3: 
2022-01-19 07:48:42 OpenVPN 2.5.1 x86_64-pc-linux-gnu [SSL (OpenSSL)] [LZO] [LZ4] [EPOLL] [PKCS11] [MH/PKTINFO] [AEAD] built on May 14 2021
2022-01-19 07:48:42 library versions: OpenSSL 1.1.1m  14 Dec 2021, LZO 2.10
2022-01-19 07:48:42 NOTE: the current --script-security setting may allow this configuration to call user-defined scripts
2022-01-19 07:48:42 TCP/UDP: Preserving recently used remote address: [AF_INET]137.193.65.225:1194
2022-01-19 07:48:42 UDPv4 link local (bound): [AF_INET][undef]:0
2022-01-19 07:48:42 UDPv4 link remote: [AF_INET]137.193.65.225:1194
2022-01-19 07:48:44 [COOLvpn] Peer Connection Initiated with [AF_INET]137.193.65.225:1194
2022-01-19 07:48:44 sitnl_send: rtnl: generic error (-101): Network is unreachable
2022-01-19 07:48:44 TUN/TAP device tap0 opened
2022-01-19 07:48:44 net_iface_mtu_set: mtu 1500 for tap0
2022-01-19 07:48:44 net_iface_up: set tap0 up
2022-01-19 07:48:44 net_addr_v4_add: 172.16.76.12/23 dev tap0
2022-01-19 07:48:44 net_iface_mtu_set: mtu 1500 for tap0
2022-01-19 07:48:44 net_iface_up: set tap0 up
2022-01-19 07:48:44 net_addr_v6_add: 2a01:4f8:c2c:8d18::ac10:4d0c/64 dev tap0
2022-01-19 07:48:44 /etc/openvpn/update-resolv-conf tap0 1500 1584 172.16.76.12 255.255.254.0 init
dhcp-option DOMAIN camp.cool.datcom.prv
dhcp-option DNS 172.16.77.1
2022-01-19 07:48:44 add_route_ipv6(2a01:4f8:c2c:8d18::ac10:4a00/120 -> fd00:10::1 metric -1) dev tap0
2022-01-19 07:48:44 sitnl_send: rtnl: generic error (-113): No route to host
2022-01-19 07:48:44 ERROR: Linux IPv6 route can't be added
2022-01-19 07:48:44 WARNING: this configuration may cache passwords in memory -- use the auth-nocache option to prevent this
2022-01-19 07:48:44 Initialization Sequence Completed
\end{lstlisting}
In den nachfolgenden Kapiteln wird eine bestehende VPN-Verbindung zum Kundennetzwerk vorausgesetzt. Sofern die Verbindung erfolgreich aufgebaut wurde, wird die Netzwerkschnittstelle \texttt{tap0} aktiviert sowie eine IP-Adresse aus dem IP-Bereich \texttt{172.16.76.0/23} vom VPN-Server (oder dem DHCP-Server) zur Verfügung gestellt. Textauszug \ref{lst:ipadd} zeigt exemplarisch die IP-Konfiguration (Kommando: \texttt{ip  address  show}) der Kali-VM nach erfolgtem Aufbau des VPN-Tunnels.

\lstset{language=bash,caption={IP-Konfiguration nach dem Aufbau des VPN-Tunnels}, label=lst:ipadd}
\begin{lstlisting}[frame=single, firstnumber=1, stepnumber=1,]
|--(gu4c4m0l3@kali-t470)-[~]
|-$ ip address show
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
    inet6 ::1/128 scope host 
       valid_lft forever preferred_lft forever
2: eth0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UP group default qlen 1000
    link/ether 08:00:27:50:4c:14 brd ff:ff:ff:ff:ff:ff
    inet 172.31.32.45/25 brd 172.31.32.127 scope global dynamic noprefixroute eth0
       valid_lft 7767974sec preferred_lft 7767974sec
    inet6 fe80::a00:27ff:fe50:4c14/64 scope link noprefixroute 
       valid_lft forever preferred_lft forever
7: vpn0: <POINTOPOINT,MULTICAST,NOARP> mtu 1400 qdisc pfifo_fast state DOWN group default qlen 500
    link/none 
10: tap0: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc pfifo_fast state UNKNOWN group default qlen 1000
    link/ether fe:50:8a:01:9c:21 brd ff:ff:ff:ff:ff:ff
    inet 172.16.76.18/23 scope global tap0
       valid_lft forever preferred_lft forever
    inet6 2a01:4f8:c2c:8d18::ac10:4d12/64 scope global 
       valid_lft forever preferred_lft forever
    inet6 fe80::fc50:8aff:fe01:9c21/64 scope link 
       valid_lft forever preferred_lft forever
\end{lstlisting}


\section{Beschreibung der Eingabeaufforderungen}
Im Verlauf des Penetrationtests werden mehrere verschiedene Computersysteme angegriffen. Zur Nachvollziehbarkeit der durchgeführten Angriffe werden die einzelnen Kommandos dokumentiert. Befehle, welche auf der Kali-VM des Penetrationtesters ausgeführt werden beginnen dabei immer mit einer zwei-zeiligen Eingabeaufforderung. Diese enthält zum einem den Benutzernamen (hier: \texttt{gu4c4m0l3}) des Penetrationtesters und den Rechnernnamen (hier: \texttt{kali-t470}). In der zweiten Zeile wird  das ausgeführte Kommando hinter dem \texttt{\$}-Zeichen angegeben. 

\lstset{language=bash,caption={Standard Eingabeaufforderung der Kali-VM}, label=lst:commandprompt}
\begin{lstlisting}[frame=single, firstnumber=1, stepnumber=1,]
|--(gu4c4m0l3@kali-t470)-[~]
|-$ <Kommando>
\end{lstlisting}

Darüber hinaus wird häufig das Penetrationtesting-Framework \emph{Metasploit}\footnote{Metasploit-Homepage: \url{https://www.rapid7.com/de/products/metasploit/}} von \emph{Rapid7} eingesetzt, welches in einer eigenen (einzeiligen) Eingabeaufforderung erscheint. Neben der Angabe des Benutzernamens und Rechnernamens (mit vorangestelltem \texttt{msf-}), wird in den eckigen Klammern die Anzahl der Metasploit-Sessions (\texttt{S:X}) und die Anzahl der aktiven Metasploit-Jobs (\texttt{J:X}) angezeigt, wobei \texttt{X} die Anzahl der entsprechenden Sessions/Jobs angibt. Die Textauszüge \ref{lst:commandprompt} und \ref{lst:commandpromptmsf} zeigen dabei exemplarisch die Standard-Eingabeaufforderung sowie die Eingabeaufforderung von Metasploit auf.

\lstset{language=bash,caption={Eingabeaufforderung unter Metasploit der Kali-VM}, label=lst:commandpromptmsf}
\begin{lstlisting}[frame=single, firstnumber=1, stepnumber=1,]
gu4c4m0l3@msf-kali-t470 [S:0, J:0] > <Metasploit-Kommando>
\end{lstlisting}

Das Metasploit-Framework ist unter Kali bereits vorinstalliert. Um den vollen Funktionsumfang von Metasploit nutzen zu können, muss vorab die PostgreSQL-Datenbank gestartet und eine Konfigurationsdatei für Metasploit angelegt werden. Darüber hinaus wurde für diesen Penetration-Test ein eigener Workspace \texttt{MB-Reps} innerhalb Metasploit angelegt. Textauszug \ref{lst:metasploit_setup} zeigt dabei die initiale Einrichtung der soeben genannten Schritte. Es wird Metasploit in der Version 6.1.27-dev verwendet.

\lstset{language=bash,caption={Initiale Einrichtung von Metasploit}, label=lst:metasploit_setup}
\begin{lstlisting}[frame=single, firstnumber=1, stepnumber=1,]
|--(gu4c4m0l3@kali-t470)-[~]
|-$ sudo msfdb init              
[+] Starting database
[+] Creating database user 'msf'
[+] Creating databases 'msf'
[+] Creating databases 'msf_test'
[+] Creating configuration file '/usr/share/metasploit-framework/config/database.yml'
[+] Creating initial database schema

|--(gu4c4m0l3@kali-t470)-[~]
|-$ sudo msfconsole -q -y /usr/share/metasploit-framework/config/database.yml

gu4c4m0l3@msf-kali-t470 [S:0, J:0] > workspace -a MB-Reps
[*] Added workspace: MB-Reps
[*] Workspace: MB-Reps
gu4c4m0l3@msf-kali-t470 [S:0, J:0] > 
gu4c4m0l3@msf-kali-t470 [S:0, J:0] > version
Framework: 6.1.27-dev
Console  : 6.1.27-dev
\end{lstlisting}

Sollten andere Kommandozeilen-Eingabeaufforderungen im weiteren Verlauf dargestellt werden, so handelt es sich um eine entfernte und meist kompromittierte Maschine.

\section{Eingesetzte Werkzeuge}
In diesem Kapitel werden zusätzliche Werkzeuge, welche neben den vorinstallierten Standard-Tools in Kali verwendet wurden, aufgelistet. Die vorinstallierten Tools von Kali können unter \url{https://www.kali.org/tools/} eingesehen werden.

\begin{itemize}
\item resolvconf
\item hcxdumptool
\item hcxtools
\end{itemize}

Die aufgelisteten Pakete können mit dem Befehl \texttt{sudo apt install <paketname>} nachinstalliert werden.


